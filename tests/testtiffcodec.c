#ifdef WIN32
#ifndef __cplusplus
#error Please compile with a C++ compiler.
#endif
#endif

#if defined(USE_WINDOWS_GDIPLUS)
#include <Windows.h>
#include <GdiPlus.h>

#pragma comment(lib, "gdiplus.lib")
#else
#include <GdiPlusFlat.h>
#endif

#if defined(USE_WINDOWS_GDIPLUS)
using namespace Gdiplus;
using namespace DllExports;
#endif

#include <assert.h>
#include <stdio.h>
#include <stdlib.h>
#include <tiffio.h>
#include "testhelpers.h"

static const char *file = "temp_asset.tif";
static WCHAR wFile[] = {'t', 'e', 'm', 'p', '_', 'a', 's', 's', 'e', 't', '.', 't', 'i', 'f', 0};
GpImage *image;

#define createFile(buffer, length, expectedStatus)          \
{                                                           \
	GpStatus status;                                    \
	FILE *f = fopen (file, "w+");                       \
	assert (f);                                         \
	fwrite ((void *) buffer, sizeof (BYTE), length, f); \
	fclose (f);                                         \
	                                                    \
	status = GdipLoadImageFromFile (wFile, &image);     \
	assertEqualInt (status, expectedStatus);            \
}

#define createFileSuccess(buffer, length, width, height, expectedFlags) \
{                                                         \
	createFile (buffer, length, Ok);                  \
	verifyImage (image, ImageTypeBitmap, tifRawFormat, PixelFormat24bppRGB, 0, 0, width, height, (REAL) width, (REAL) height, expectedFlags, 15, TRUE); \
	                                                  \
	GdipDisposeImage (image);                         \
}

static void test_valid ()
{
	BYTE validData24bpp[] = {
		/* Header */                     0x49, 0x49, 0x2A, 0x00, 0x0E, 0x00, 0x00, 0x00, 0x80, 0x3F, 0xE0, 0x50, 0x10, 0x00,
		/* Number of Tags */             0x0F, 0x00,
		
		/* NewSubFileType */             0xFE, 0x00, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		/* ImageWidth */                 0x00, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* ImageHeight */                0x01, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* BitsPerSample */              0x02, 0x01, 0x03, 0x00, 0x03, 0x00, 0x00, 0x00, 0xC8, 0x00, 0x00, 0x00,
		/* Compression */                0x03, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
		/* PhotometricInterpretation */  0x06, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* StripOffsets */               0x11, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
		/* SamplesPerPixel */            0x15, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
		/* RowsPerStrip */               0x16, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* StripByteCounts */            0x17, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
		/* XResolution */                0x1A, 0x01, 0x05, 0x00, 0x01, 0x00, 0x00, 0x00, 0xCE, 0x00, 0x00, 0x00,
		/* YResolution */                0x1B, 0x01, 0x05, 0x00, 0x01, 0x00, 0x00, 0x00, 0xD6, 0x00, 0x00, 0x00,
		/* PlanarConfiguration */        0x1C, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* ResolutionUnit */             0x28, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* Predictor */                  0x3D, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* Next IFD Offset */            0x00, 0x00, 0x00, 0x00,
		
		/* BitsPerSample Data */         0x08, 0x00, 0x08, 0x00, 0x08, 0x00,
		/* XResolution Data */           0x00, 0x77, 0x01, 0x00, 0xE8, 0x03, 0x00, 0x00,
		/* YResolution Data */           0x00, 0x77, 0x01, 0x00, 0xE8, 0x03, 0x00, 0x00
	};
	BYTE missingRequiredTagsAccordingToSpec[] = {
		/* Header */                     0x49, 0x49, 0x2A, 0x00, 0x0E, 0x00, 0x00, 0x00, 0x80, 0x3F, 0xE0, 0x50, 0x10, 0x00,
		/* Number of Tags */             0x05, 0x00,
		
		/* ImageWidth */                 0x00, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* ImageHeight */                0x01, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* BitsPerSample */              0x02, 0x01, 0x03, 0x00, 0x03, 0x00, 0x00, 0x00, 0x50, 0x00, 0x00, 0x00,
		/* StripOffsets */               0x11, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
		/* SamplesPerPixel */            0x15, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
		/* Next IFD Offset */            0x00, 0x00, 0x00, 0x00,
		
		/* BitsPerSample Data */         0x08, 0x00, 0x08, 0x00, 0x08, 0x00,
	};
	BYTE invalidNextIFDOffset[] = {
		/* Header */                     0x49, 0x49, 0x2A, 0x00, 0x0E, 0x00, 0x00, 0x00, 0x80, 0x3F, 0xE0, 0x50, 0x10, 0x00,
		/* Number of Tags */             0x0F, 0x00,
		
		/* NewSubFileType */             0xFE, 0x00, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		/* ImageWidth */                 0x00, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* ImageHeight */                0x01, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* BitsPerSample */              0x02, 0x01, 0x03, 0x00, 0x03, 0x00, 0x00, 0x00, 0xC8, 0x00, 0x00, 0x00,
		/* Compression */                0x03, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
		/* PhotometricInterpretation */  0x06, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* StripOffsets */               0x11, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
		/* SamplesPerPixel */            0x15, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
		/* RowsPerStrip */               0x16, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* StripByteCounts */            0x17, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
		/* XResolution */                0x1A, 0x01, 0x05, 0x00, 0x01, 0x00, 0x00, 0x00, 0xCE, 0x00, 0x00, 0x00,
		/* YResolution */                0x1B, 0x01, 0x05, 0x00, 0x01, 0x00, 0x00, 0x00, 0xD6, 0x00, 0x00, 0x00,
		/* PlanarConfiguration */        0x1C, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* ResolutionUnit */             0x28, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* Predictor */                  0x3D, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* Next IFD Offset */            0xFF, 0x00, 0x00, 0x00,
		
		/* BitsPerSample Data */         0x08, 0x00, 0x08, 0x00, 0x08, 0x00,
		/* XResolution Data */           0x00, 0x77, 0x01, 0x00, 0xE8, 0x03, 0x00, 0x00,
		/* YResolution Data */           0x00, 0x77, 0x01, 0x00, 0xE8, 0x03, 0x00, 0x00
	};

	createFileSuccess (validData24bpp, sizeof (validData24bpp), 1, 1, ImageFlagsColorSpaceRGB | ImageFlagsHasRealDPI | ImageFlagsHasRealPixelSize | ImageFlagsReadOnly);

	// Version not 0x2A.
	validData24bpp[3] = 0x00;
	createFileSuccess (validData24bpp, sizeof (validData24bpp), 1, 1, ImageFlagsColorSpaceRGB | ImageFlagsHasRealDPI | ImageFlagsHasRealPixelSize | ImageFlagsReadOnly);

	createFileSuccess (missingRequiredTagsAccordingToSpec, sizeof (missingRequiredTagsAccordingToSpec), 1, 1, ImageFlagsColorSpaceRGB | ImageFlagsHasRealPixelSize | ImageFlagsReadOnly);
	createFileSuccess (invalidNextIFDOffset, sizeof (invalidNextIFDOffset), 1, 1, ImageFlagsColorSpaceRGB | ImageFlagsHasRealDPI | ImageFlagsHasRealPixelSize | ImageFlagsReadOnly);
}

static void test_invalidHeader ()
{
	BYTE noVersionNumberLE[]    = {0x49, 0x49};
	BYTE noVersionNumberBE[]    = {0x4D, 0x4D};
	BYTE shortVersionNumberLE[] = {0x49, 0x49, 0x2A};
	BYTE shortVersionNumberBE[] = {0x4D, 0x4D, 0x2A};
	BYTE noOffsetLE[]           = {0x49, 0x49, 0x2A, 0x00};
	BYTE noOffsetBE[]           = {0x4D, 0x4D, 0x00, 0x2A};
	BYTE shortOffsetLE[]        = {0x49, 0x49, 0x2A, 0x00, 0x08};
	BYTE shortOffsetBE[]        = {0x4D, 0x4D, 0x00, 0x2A, 0x00};
	BYTE zeroOffsetLE[] = {
		/* Header */                     0x49, 0x49, 0x2A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x3F, 0xE0, 0x50, 0x10, 0x00,
		/* Number of Tags */             0x0F, 0x00,
		
		/* NewSubFileType */             0xFE, 0x00, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		/* ImageWidth */                 0x00, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* ImageHeight */                0x01, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* BitsPerSample */              0x02, 0x01, 0x03, 0x00, 0x03, 0x00, 0x00, 0x00, 0xC8, 0x00, 0x00, 0x00,
		/* Compression */                0x03, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
		/* PhotometricInterpretation */  0x06, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* StripOffsets */               0x11, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
		/* SamplesPerPixel */            0x15, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
		/* RowsPerStrip */               0x16, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* StripByteCounts */            0x17, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
		/* XResolution */                0x1A, 0x01, 0x05, 0x00, 0x01, 0x00, 0x00, 0x00, 0xCE, 0x00, 0x00, 0x00,
		/* YResolution */                0x1B, 0x01, 0x05, 0x00, 0x01, 0x00, 0x00, 0x00, 0xD6, 0x00, 0x00, 0x00,
		/* PlanarConfiguration */        0x1C, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* ResolutionUnit */             0x28, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* Predictor */                  0x3D, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* Next IFD Offset */            0x00, 0x00, 0x00, 0x00,
		
		/* BitsPerSample Data */         0x08, 0x00, 0x08, 0x00, 0x08, 0x00,
		/* XResolution Data */           0x00, 0x77, 0x01, 0x00, 0xE8, 0x03, 0x00, 0x00,
		/* YResolution Data */           0x00, 0x77, 0x01, 0x00, 0xE8, 0x03, 0x00, 0x00
	};
	BYTE overlappingOffsetLE[] = {
		/* Header */                     0x49, 0x49, 0x2A, 0x00, 0x07, 0x00, 0x00, 0x00, 0x80, 0x3F, 0xE0, 0x50, 0x10, 0x00,
		/* Number of Tags */             0x0F, 0x00,
		
		/* NewSubFileType */             0xFE, 0x00, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		/* ImageWidth */                 0x00, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* ImageHeight */                0x01, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* BitsPerSample */              0x02, 0x01, 0x03, 0x00, 0x03, 0x00, 0x00, 0x00, 0xC8, 0x00, 0x00, 0x00,
		/* Compression */                0x03, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
		/* PhotometricInterpretation */  0x06, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* StripOffsets */               0x11, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
		/* SamplesPerPixel */            0x15, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
		/* RowsPerStrip */               0x16, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* StripByteCounts */            0x17, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
		/* XResolution */                0x1A, 0x01, 0x05, 0x00, 0x01, 0x00, 0x00, 0x00, 0xCE, 0x00, 0x00, 0x00,
		/* YResolution */                0x1B, 0x01, 0x05, 0x00, 0x01, 0x00, 0x00, 0x00, 0xD6, 0x00, 0x00, 0x00,
		/* PlanarConfiguration */        0x1C, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* ResolutionUnit */             0x28, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* Predictor */                  0x3D, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* Next IFD Offset */            0x00, 0x00, 0x00, 0x00,
		
		/* BitsPerSample Data */         0x08, 0x00, 0x08, 0x00, 0x08, 0x00,
		/* XResolution Data */           0x00, 0x77, 0x01, 0x00, 0xE8, 0x03, 0x00, 0x00,
		/* YResolution Data */           0x00, 0x77, 0x01, 0x00, 0xE8, 0x03, 0x00, 0x00
	};
	BYTE invalidOffsetLE[] = {
		/* Header */                     0x49, 0x49, 0x2A, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x80, 0x3F, 0xE0, 0x50, 0x10, 0x00,
		/* Number of Tags */             0x0F, 0x00,
		
		/* NewSubFileType */             0xFE, 0x00, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		/* ImageWidth */                 0x00, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* ImageHeight */                0x01, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* BitsPerSample */              0x02, 0x01, 0x03, 0x00, 0x03, 0x00, 0x00, 0x00, 0xC8, 0x00, 0x00, 0x00,
		/* Compression */                0x03, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
		/* PhotometricInterpretation */  0x06, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* StripOffsets */               0x11, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
		/* SamplesPerPixel */            0x15, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
		/* RowsPerStrip */               0x16, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* StripByteCounts */            0x17, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
		/* XResolution */                0x1A, 0x01, 0x05, 0x00, 0x01, 0x00, 0x00, 0x00, 0xCE, 0x00, 0x00, 0x00,
		/* YResolution */                0x1B, 0x01, 0x05, 0x00, 0x01, 0x00, 0x00, 0x00, 0xD6, 0x00, 0x00, 0x00,
		/* PlanarConfiguration */        0x1C, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* ResolutionUnit */             0x28, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* Predictor */                  0x3D, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* Next IFD Offset */            0x00, 0x00, 0x00, 0x00,
		
		/* BitsPerSample Data */         0x08, 0x00, 0x08, 0x00, 0x08, 0x00,
		/* XResolution Data */           0x00, 0x77, 0x01, 0x00, 0xE8, 0x03, 0x00, 0x00,
		/* YResolution Data */           0x00, 0x77, 0x01, 0x00, 0xE8, 0x03, 0x00, 0x00
	};

	createFile (noVersionNumberLE, sizeof (noVersionNumberLE), OutOfMemory);
	createFile (noVersionNumberBE, sizeof (noVersionNumberBE), OutOfMemory);
	createFile (shortVersionNumberLE, sizeof (shortVersionNumberLE), OutOfMemory);
	createFile (shortVersionNumberBE, sizeof (shortVersionNumberBE), OutOfMemory);
	createFile (noOffsetLE, sizeof (noOffsetLE), OutOfMemory);
	createFile (noOffsetBE, sizeof (noOffsetBE), OutOfMemory);
	createFile (shortOffsetLE, sizeof (shortOffsetLE), OutOfMemory);
	createFile (shortOffsetBE, sizeof (shortOffsetBE), OutOfMemory);
	createFile (zeroOffsetLE, sizeof (zeroOffsetLE), OutOfMemory);
	createFile (overlappingOffsetLE, sizeof (overlappingOffsetLE), OutOfMemory);
	createFile (invalidOffsetLE, sizeof (invalidOffsetLE), OutOfMemory);
}

static void test_invalidFileDirectory ()
{
	BYTE noNumberOfEntriesLE[] = {
		/* Header */ 0x49, 0x49, 0x2A, 0x00, 0x80, 0x00, 0x00, 0x00
	};
	BYTE noNumberOfEntriesBE[] = {
		/* Header */ 0x4D, 0x4D, 0x00, 0x2A, 0x00, 0x00, 0x00, 0x08
	};
	BYTE shortNumberOfEntriesLE[] = {
		/* Header */ 0x49, 0x49, 0x2A, 0x00, 0x08, 0x00, 0x00, 0x00,
		/* IFD 1 */  0x01
	};
	BYTE shortNumberOfEntriesBE[] = {
		/* Header */ 0x4D, 0x4D, 0x00, 0x2A, 0x00, 0x00, 0x00, 0x08,
		/* IFD 1 */  0x00
	};
	BYTE noNextIFDOffsetLE[] = {
		/* Header */          0x49, 0x49, 0x2A, 0x00, 0x08, 0x00, 0x00, 0x00,
		/* IFD 1 */           0x01, 0x00,
		/* NewSubFileType */  0xFE, 0x00, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	};
	BYTE noNextIFDOffsetBE[] = {
		/* Header */          0x4D, 0x4D, 0x00, 0x2A, 0x00, 0x00, 0x00, 0x08,
		/* IFD 1 */           0x00, 0x01,
		/* NewSubFileType */  0x00, 0xFE, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00
	};
	BYTE shortNextIFDOffsetLE[] = {
		/* Header */          0x49, 0x49, 0x2A, 0x00, 0x08, 0x00, 0x00, 0x00,
		/* IFD 1 */           0x01, 0x00,
		/* NewSubFileType */  0xFE, 0x00, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		/* IFD 1 */           0x00, 0x00, 0x00
	};
	BYTE shortNextIFDOffsetBE[] = {
		/* Header */          0x4D, 0x4D, 0x00, 0x2A, 0x00, 0x00, 0x00, 0x08,
		/* IFD 1 */           0x00, 0x01,
		/* NewSubFileType */  0x00, 0xFE, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
		/* IFD 1 */           0x00, 0x00, 0x00
	};
	BYTE zeroNumberOfEntries[] = {
		/* Header */          0x4D, 0x4D, 0x00, 0x2A, 0x00, 0x00, 0x00, 0x08,
		/* IFD 1 */           0x00, 0x00,
		/* IFD 1 */           0x00, 0x00, 0x00, 0x00
	};
#if defined(USE_WINDOWS_GDIPLUS)
	BYTE recursiveNextIFDOffset[] = {
		/* Header */                     0x49, 0x49, 0x2A, 0x00, 0x0E, 0x00, 0x00, 0x00, 0x80, 0x3F, 0xE0, 0x50, 0x10, 0x00,
		/* Number of Tags */             0x0F, 0x00,
		
		/* NewSubFileType */             0xFE, 0x00, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		/* ImageWidth */                 0x00, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* ImageHeight */                0x01, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* BitsPerSample */              0x02, 0x01, 0x03, 0x00, 0x03, 0x00, 0x00, 0x00, 0xC8, 0x00, 0x00, 0x00,
		/* Compression */                0x03, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
		/* PhotometricInterpretation */  0x06, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* StripOffsets */               0x11, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
		/* SamplesPerPixel */            0x15, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
		/* RowsPerStrip */               0x16, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* StripByteCounts */            0x17, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
		/* XResolution */                0x1A, 0x01, 0x05, 0x00, 0x01, 0x00, 0x00, 0x00, 0xCE, 0x00, 0x00, 0x00,
		/* YResolution */                0x1B, 0x01, 0x05, 0x00, 0x01, 0x00, 0x00, 0x00, 0xD6, 0x00, 0x00, 0x00,
		/* PlanarConfiguration */        0x1C, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* ResolutionUnit */             0x28, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* Predictor */                  0x3D, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* Next IFD Offset */            0x0E, 0x00, 0x00, 0x00,
		
		/* BitsPerSample Data */         0x08, 0x00, 0x08, 0x00, 0x08, 0x00,
		/* XResolution Data */           0x00, 0x77, 0x01, 0x00, 0xE8, 0x03, 0x00, 0x00,
		/* YResolution Data */           0x00, 0x77, 0x01, 0x00, 0xE8, 0x03, 0x00, 0x00
	};
#endif

	createFile (noNumberOfEntriesLE, sizeof (noNumberOfEntriesLE), OutOfMemory);
	createFile (noNumberOfEntriesBE, sizeof (noNumberOfEntriesBE), OutOfMemory);
	createFile (shortNumberOfEntriesLE, sizeof (shortNumberOfEntriesLE), OutOfMemory);
	createFile (shortNumberOfEntriesBE, sizeof (shortNumberOfEntriesBE), OutOfMemory);
	createFile (noNextIFDOffsetLE, sizeof (noNextIFDOffsetLE), OutOfMemory);
	createFile (noNextIFDOffsetBE, sizeof (noNextIFDOffsetBE), OutOfMemory);
	createFile (shortNextIFDOffsetLE, sizeof (shortNextIFDOffsetLE), OutOfMemory);
	createFile (shortNextIFDOffsetBE, sizeof (shortNextIFDOffsetBE), OutOfMemory);
	createFile (zeroNumberOfEntries, sizeof (zeroNumberOfEntries), OutOfMemory);
	// FIXME: this loops forever with libgdiplus.
#if defined(USE_WINDOWS_GDIPLUS)
	createFile (recursiveNextIFDOffset, sizeof (recursiveNextIFDOffset), OutOfMemory);
#endif
}

static void test_invalidTag ()
{
	BYTE noTagIdLE[] = {
		/* Header */ 0x49, 0x49, 0x2A, 0x00, 0x08, 0x00, 0x00, 0x00,
		/* IFD 1 */  0x01, 0x00
	};
	BYTE noTagIdBE[] = {
		/* Header */ 0x4D, 0x4D, 0x00, 0x2A, 0x00, 0x00, 0x00, 0x08,
		/* IFD 1 */  0x00, 0x01
	};
	BYTE shortTagIdLE[] = {
		/* Header */          0x49, 0x49, 0x2A, 0x00, 0x08, 0x00, 0x00, 0x00,
		/* IFD 1 */           0x01, 0x00,
		/* NewSubFileType */  0xFE
	};
	BYTE shortTagIdBE[] = {
		/* Header */          0x4D, 0x4D, 0x00, 0x2A, 0x00, 0x00, 0x00, 0x08,
		/* IFD 1 */           0x00, 0x01,
		/* NewSubFileType */  0x00
	};
	BYTE noTagDataTypeLE[] = {
		/* Header */          0x49, 0x49, 0x2A, 0x00, 0x08, 0x00, 0x00, 0x00,
		/* IFD 1 */           0x01, 0x00,
		/* NewSubFileType */  0xFE, 0x00
	};
	BYTE noTagDataTypeBE[] = {
		/* Header */          0x4D, 0x4D, 0x00, 0x2A, 0x00, 0x00, 0x00, 0x08,
		/* IFD 1 */           0x00, 0x01,
		/* NewSubFileType */  0x00, 0xFE
	};
	BYTE shortTagDataTypeLE[] = {
		/* Header */          0x49, 0x49, 0x2A, 0x00, 0x08, 0x00, 0x00, 0x00,
		/* IFD 1 */           0x01, 0x00,
		/* NewSubFileType */  0xFE, 0x00, 0x04
	};
	BYTE shortTagDataTypeBE[] = {
		/* Header */          0x4D, 0x4D, 0x00, 0x2A, 0x00, 0x00, 0x00, 0x08,
		/* IFD 1 */           0x00, 0x01,
		/* NewSubFileType */  0x00, 0xFE, 0x00
	};
	BYTE noTagDataCountLE[] = {
		/* Header */          0x49, 0x49, 0x2A, 0x00, 0x08, 0x00, 0x00, 0x00,
		/* IFD 1 */           0x01, 0x00,
		/* NewSubFileType */  0xFE, 0x00, 0x04, 0x00
	};
	BYTE noTagDataCountBE[] = {
		/* Header */          0x4D, 0x4D, 0x00, 0x2A, 0x00, 0x00, 0x00, 0x08,
		/* IFD 1 */           0x00, 0x01,
		/* NewSubFileType */  0x00, 0xFE, 0x00, 0x04
	};
	BYTE shortTagDataCountLE[] = {
		/* Header */          0x49, 0x49, 0x2A, 0x00, 0x08, 0x00, 0x00, 0x00,
		/* IFD 1 */           0x01, 0x00,
		/* NewSubFileType */  0xFE, 0x00, 0x04, 0x00, 0x01, 0x00, 0x00
	};
	BYTE shortTagDataCountBE[] = {
		/* Header */          0x4D, 0x4D, 0x00, 0x2A, 0x00, 0x00, 0x00, 0x08,
		/* IFD 1 */           0x00, 0x01,
		/* NewSubFileType */  0x00, 0xFE, 0x00, 0x04, 0x00, 0x00, 0x00
	};
	BYTE noTagDataOffsetLE[] = {
		/* Header */          0x49, 0x49, 0x2A, 0x00, 0x08, 0x00, 0x00, 0x00,
		/* IFD 1 */           0x01, 0x00,
		/* NewSubFileType */  0xFE, 0x00, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00
	};
	BYTE noTagDataOffsetBE[] = {
		/* Header */          0x4D, 0x4D, 0x00, 0x2A, 0x00, 0x00, 0x00, 0x08,
		/* IFD 1 */           0x00, 0x01,
		/* NewSubFileType */  0x00, 0xFE, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01
	};
	BYTE shortTagDataOffsetLE[] = {
		/* Header */          0x49, 0x49, 0x2A, 0x00, 0x08, 0x00, 0x00, 0x00,
		/* IFD 1 */           0x01, 0x00,
		/* NewSubFileType */  0xFE, 0x00, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
	};
	BYTE shortTagDataOffsetBE[] = {
		/* Header */          0x4D, 0x4D, 0x00, 0x2A, 0x00, 0x00, 0x00, 0x08,
		/* IFD 1 */           0x00, 0x01,
		/* NewSubFileType */  0x00, 0xFE, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00
	};
	BYTE invalidDataOffsetLE[] = {
		/* Header */                     0x49, 0x49, 0x2A, 0x00, 0x0E, 0x00, 0x00, 0x00, 0x80, 0x3F, 0xE0, 0x50, 0x10, 0x00,
		/* Number of Tags */             0x0F, 0x00,
		
		/* NewSubFileType */             0xFE, 0x00, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		/* ImageWidth */                 0x00, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		/* ImageHeight */                0x01, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* BitsPerSample */              0x02, 0x01, 0x03, 0x00, 0x03, 0x00, 0x00, 0x00, 0xC8, 0x00, 0x00, 0x00,
		/* Compression */                0x03, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
		/* PhotometricInterpretation */  0x06, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* StripOffsets */               0x11, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
		/* SamplesPerPixel */            0x15, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
		/* RowsPerStrip */               0x16, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* StripByteCounts */            0x17, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
		/* XResolution */                0x1A, 0x01, 0x05, 0x00, 0x01, 0x00, 0x00, 0x00, 0xCE, 0x00, 0x00, 0x00,
		/* YResolution */                0x1B, 0x01, 0x05, 0x00, 0x01, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00,
		/* PlanarConfiguration */        0x1C, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* ResolutionUnit */             0x28, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* Predictor */                  0x3D, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* Next IFD Offset */            0x00, 0x00, 0x00, 0x00,
		
		/* BitsPerSample Data */         0x08, 0x00, 0x08, 0x00, 0x08, 0x00,
		/* XResolution Data */           0x00, 0x77, 0x01, 0x00, 0xE8, 0x03, 0x00, 0x00,
		/* YResolution Data */           0x00, 0x77, 0x01, 0x00, 0xE8, 0x03, 0x00, 0x00
	};

	createFile (noTagIdLE, sizeof (noTagIdLE), OutOfMemory);
	createFile (noTagIdBE, sizeof (noTagIdBE), OutOfMemory);
	createFile (shortTagIdLE, sizeof (shortTagIdLE), OutOfMemory);
	createFile (shortTagIdBE, sizeof (shortTagIdBE), OutOfMemory);
	createFile (noTagDataTypeLE, sizeof (noTagDataTypeLE), OutOfMemory);
	createFile (noTagDataTypeBE, sizeof (noTagDataTypeBE), OutOfMemory);
	createFile (shortTagDataTypeLE, sizeof (shortTagDataTypeLE), OutOfMemory);
	createFile (shortTagDataTypeBE, sizeof (shortTagDataTypeBE), OutOfMemory);
	createFile (noTagDataCountLE, sizeof (noTagDataCountLE), OutOfMemory);
	createFile (noTagDataCountBE, sizeof (noTagDataCountBE), OutOfMemory);
	createFile (shortTagDataCountLE, sizeof (shortTagDataCountLE), OutOfMemory);
	createFile (shortTagDataCountBE, sizeof (shortTagDataCountBE), OutOfMemory);
	createFile (noTagDataOffsetLE, sizeof (noTagDataOffsetLE), OutOfMemory);
	createFile (noTagDataOffsetBE, sizeof (noTagDataOffsetBE), OutOfMemory);
	createFile (shortTagDataOffsetLE, sizeof (shortTagDataOffsetLE), OutOfMemory);
	createFile (shortTagDataOffsetBE, sizeof (shortTagDataOffsetBE), OutOfMemory);
	createFile (invalidDataOffsetLE, sizeof (invalidDataOffsetLE), OutOfMemory);
}

static void test_missingTag ()
{
	BYTE missingImageWidthTag[] = {
		/* Header */                     0x49, 0x49, 0x2A, 0x00, 0x0E, 0x00, 0x00, 0x00, 0x80, 0x3F, 0xE0, 0x50, 0x10, 0x00,
		/* Number of Tags */             0x0E, 0x00,
		
		/* NewSubFileType */             0xFE, 0x00, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		/* ImageHeight */                0x01, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* BitsPerSample */              0x02, 0x01, 0x03, 0x00, 0x03, 0x00, 0x00, 0x00, 0xBC, 0x00, 0x00, 0x00,
		/* Compression */                0x03, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
		/* PhotometricInterpretation */  0x06, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* StripOffsets */               0x11, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
		/* SamplesPerPixel */            0x15, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
		/* RowsPerStrip */               0x16, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* StripByteCounts */            0x17, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
		/* XResolution */                0x1A, 0x01, 0x05, 0x00, 0x01, 0x00, 0x00, 0x00, 0xBE, 0x00, 0x00, 0x00,
		/* YResolution */                0x1B, 0x01, 0x05, 0x00, 0x01, 0x00, 0x00, 0x00, 0xCA, 0x00, 0x00, 0x00,
		/* PlanarConfiguration */        0x1C, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* ResolutionUnit */             0x28, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* Predictor */                  0x3D, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* Next IFD Offset */            0x00, 0x00, 0x00, 0x00,
		
		/* BitsPerSample Data */         0x08, 0x00, 0x08, 0x00, 0x08, 0x00,
		/* XResolution Data */           0x00, 0x77, 0x01, 0x00, 0xE8, 0x03, 0x00, 0x00,
		/* YResolution Data */           0x00, 0x77, 0x01, 0x00, 0xE8, 0x03, 0x00, 0x00
	};
	BYTE missingImageHeightTag[] = {
		/* Header */                     0x49, 0x49, 0x2A, 0x00, 0x0E, 0x00, 0x00, 0x00, 0x80, 0x3F, 0xE0, 0x50, 0x10, 0x00,
		/* Number of Tags */             0x0E, 0x00,
		
		/* NewSubFileType */             0xFE, 0x00, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		/* ImageWidth */                 0x00, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* BitsPerSample */              0x02, 0x01, 0x03, 0x00, 0x03, 0x00, 0x00, 0x00, 0xBC, 0x00, 0x00, 0x00,
		/* Compression */                0x03, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
		/* PhotometricInterpretation */  0x06, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* StripOffsets */               0x11, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
		/* SamplesPerPixel */            0x15, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
		/* RowsPerStrip */               0x16, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* StripByteCounts */            0x17, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
		/* XResolution */                0x1A, 0x01, 0x05, 0x00, 0x01, 0x00, 0x00, 0x00, 0xBE, 0x00, 0x00, 0x00,
		/* YResolution */                0x1B, 0x01, 0x05, 0x00, 0x01, 0x00, 0x00, 0x00, 0xCA, 0x00, 0x00, 0x00,
		/* PlanarConfiguration */        0x1C, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* ResolutionUnit */             0x28, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* Predictor */                  0x3D, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* Next IFD Offset */            0x00, 0x00, 0x00, 0x00,
		
		/* BitsPerSample Data */         0x08, 0x00, 0x08, 0x00, 0x08, 0x00,
		/* XResolution Data */           0x00, 0x77, 0x01, 0x00, 0xE8, 0x03, 0x00, 0x00,
		/* YResolution Data */           0x00, 0x77, 0x01, 0x00, 0xE8, 0x03, 0x00, 0x00
	};
	BYTE missingBitsPerSampleTag[] = {
		/* Header */                     0x49, 0x49, 0x2A, 0x00, 0x0E, 0x00, 0x00, 0x00, 0x80, 0x3F, 0xE0, 0x50, 0x10, 0x00,
		/* Number of Tags */             0x0E, 0x00,
		
		/* NewSubFileType */             0xFE, 0x00, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		/* ImageWidth */                 0x00, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* ImageHeight */                0x01, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* Compression */                0x03, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
		/* PhotometricInterpretation */  0x06, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* StripOffsets */               0x11, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
		/* SamplesPerPixel */            0x15, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
		/* RowsPerStrip */               0x16, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* StripByteCounts */            0x17, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
		/* XResolution */                0x1A, 0x01, 0x05, 0x00, 0x01, 0x00, 0x00, 0x00, 0xBE, 0x00, 0x00, 0x00,
		/* YResolution */                0x1B, 0x01, 0x05, 0x00, 0x01, 0x00, 0x00, 0x00, 0xCA, 0x00, 0x00, 0x00,
		/* PlanarConfiguration */        0x1C, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* ResolutionUnit */             0x28, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* Predictor */                  0x3D, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* Next IFD Offset */            0x00, 0x00, 0x00, 0x00,
		
		/* BitsPerSample Data */         0x08, 0x00, 0x08, 0x00, 0x08, 0x00,
		/* XResolution Data */           0x00, 0x77, 0x01, 0x00, 0xE8, 0x03, 0x00, 0x00,
		/* YResolution Data */           0x00, 0x77, 0x01, 0x00, 0xE8, 0x03, 0x00, 0x00
	};
	BYTE missingStripOffsetsTag[] = {
		/* Header */                     0x49, 0x49, 0x2A, 0x00, 0x0E, 0x00, 0x00, 0x00, 0x80, 0x3F, 0xE0, 0x50, 0x10, 0x00,
		/* Number of Tags */             0x0E, 0x00,
		
		/* NewSubFileType */             0xFE, 0x00, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		/* ImageWidth */                 0x00, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* ImageHeight */                0x01, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* BitsPerSample */              0x02, 0x01, 0x03, 0x00, 0x03, 0x00, 0x00, 0x00, 0xBC, 0x00, 0x00, 0x00,
		/* Compression */                0x03, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
		/* PhotometricInterpretation */  0x06, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* SamplesPerPixel */            0x15, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
		/* RowsPerStrip */               0x16, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* StripByteCounts */            0x17, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
		/* XResolution */                0x1A, 0x01, 0x05, 0x00, 0x01, 0x00, 0x00, 0x00, 0xBE, 0x00, 0x00, 0x00,
		/* YResolution */                0x1B, 0x01, 0x05, 0x00, 0x01, 0x00, 0x00, 0x00, 0xCA, 0x00, 0x00, 0x00,
		/* PlanarConfiguration */        0x1C, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* ResolutionUnit */             0x28, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* Predictor */                  0x3D, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* Next IFD Offset */            0x00, 0x00, 0x00, 0x00,
		
		/* BitsPerSample Data */         0x08, 0x00, 0x08, 0x00, 0x08, 0x00,
		/* XResolution Data */           0x00, 0x77, 0x01, 0x00, 0xE8, 0x03, 0x00, 0x00,
		/* YResolution Data */           0x00, 0x77, 0x01, 0x00, 0xE8, 0x03, 0x00, 0x00
	};
	BYTE missingSamplesPerPixelTag[] = {
		/* Header */                     0x49, 0x49, 0x2A, 0x00, 0x0E, 0x00, 0x00, 0x00, 0x80, 0x3F, 0xE0, 0x50, 0x10, 0x00,
		/* Number of Tags */             0x0E, 0x00,
		
		/* NewSubFileType */             0xFE, 0x00, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		/* ImageWidth */                 0x00, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* ImageHeight */                0x01, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* BitsPerSample */              0x02, 0x01, 0x03, 0x00, 0x03, 0x00, 0x00, 0x00, 0xBC, 0x00, 0x00, 0x00,
		/* Compression */                0x03, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
		/* PhotometricInterpretation */  0x06, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* StripOffsets */               0x11, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
		/* RowsPerStrip */               0x16, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* StripByteCounts */            0x17, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
		/* XResolution */                0x1A, 0x01, 0x05, 0x00, 0x01, 0x00, 0x00, 0x00, 0xBE, 0x00, 0x00, 0x00,
		/* YResolution */                0x1B, 0x01, 0x05, 0x00, 0x01, 0x00, 0x00, 0x00, 0xCA, 0x00, 0x00, 0x00,
		/* PlanarConfiguration */        0x1C, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* ResolutionUnit */             0x28, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* Predictor */                  0x3D, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* Next IFD Offset */            0x00, 0x00, 0x00, 0x00,
		
		/* BitsPerSample Data */         0x08, 0x00, 0x08, 0x00, 0x08, 0x00,
		/* XResolution Data */           0x00, 0x77, 0x01, 0x00, 0xE8, 0x03, 0x00, 0x00,
		/* YResolution Data */           0x00, 0x77, 0x01, 0x00, 0xE8, 0x03, 0x00, 0x00
	};

	createFile (missingImageWidthTag, sizeof (missingImageWidthTag), OutOfMemory);
	createFile (missingImageHeightTag, sizeof (missingImageHeightTag), OutOfMemory);
	createFile (missingBitsPerSampleTag, sizeof (missingBitsPerSampleTag), OutOfMemory);
	createFile (missingStripOffsetsTag, sizeof (missingStripOffsetsTag), OutOfMemory);
	createFile (missingSamplesPerPixelTag, sizeof (missingSamplesPerPixelTag), OutOfMemory);
}

static void test_invalidSpecificTag ()
{
	BYTE zeroImageWidth[] = {
		/* Header */                     0x49, 0x49, 0x2A, 0x00, 0x0E, 0x00, 0x00, 0x00, 0x80, 0x3F, 0xE0, 0x50, 0x10, 0x00,
		/* Number of Tags */             0x0F, 0x00,
		
		/* NewSubFileType */             0xFE, 0x00, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		/* ImageWidth */                 0x00, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		/* ImageHeight */                0x01, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* BitsPerSample */              0x02, 0x01, 0x03, 0x00, 0x03, 0x00, 0x00, 0x00, 0xC8, 0x00, 0x00, 0x00,
		/* Compression */                0x03, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
		/* PhotometricInterpretation */  0x06, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* StripOffsets */               0x11, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
		/* SamplesPerPixel */            0x15, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
		/* RowsPerStrip */               0x16, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* StripByteCounts */            0x17, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
		/* XResolution */                0x1A, 0x01, 0x05, 0x00, 0x01, 0x00, 0x00, 0x00, 0xCE, 0x00, 0x00, 0x00,
		/* YResolution */                0x1B, 0x01, 0x05, 0x00, 0x01, 0x00, 0x00, 0x00, 0xD6, 0x00, 0x00, 0x00,
		/* PlanarConfiguration */        0x1C, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* ResolutionUnit */             0x28, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* Predictor */                  0x3D, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* Next IFD Offset */            0x00, 0x00, 0x00, 0x00,
		
		/* BitsPerSample Data */         0x08, 0x00, 0x08, 0x00, 0x08, 0x00,
		/* XResolution Data */           0x00, 0x77, 0x01, 0x00, 0xE8, 0x03, 0x00, 0x00,
		/* YResolution Data */           0x00, 0x77, 0x01, 0x00, 0xE8, 0x03, 0x00, 0x00
	};
	BYTE zeroImageHeight[] = {
		/* Header */                     0x49, 0x49, 0x2A, 0x00, 0x0E, 0x00, 0x00, 0x00, 0x80, 0x3F, 0xE0, 0x50, 0x10, 0x00,
		/* Number of Tags */             0x0F, 0x00,
		
		/* NewSubFileType */             0xFE, 0x00, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		/* ImageWidth */                 0x00, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* ImageHeight */                0x01, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		/* BitsPerSample */              0x02, 0x01, 0x03, 0x00, 0x03, 0x00, 0x00, 0x00, 0xC8, 0x00, 0x00, 0x00,
		/* Compression */                0x03, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
		/* PhotometricInterpretation */  0x06, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* StripOffsets */               0x11, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
		/* SamplesPerPixel */            0x15, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
		/* RowsPerStrip */               0x16, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* StripByteCounts */            0x17, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
		/* XResolution */                0x1A, 0x01, 0x05, 0x00, 0x01, 0x00, 0x00, 0x00, 0xCE, 0x00, 0x00, 0x00,
		/* YResolution */                0x1B, 0x01, 0x05, 0x00, 0x01, 0x00, 0x00, 0x00, 0xD6, 0x00, 0x00, 0x00,
		/* PlanarConfiguration */        0x1C, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* ResolutionUnit */             0x28, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* Predictor */                  0x3D, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* Next IFD Offset */            0x00, 0x00, 0x00, 0x00,
		
		/* BitsPerSample Data */         0x08, 0x00, 0x08, 0x00, 0x08, 0x00,
		/* XResolution Data */           0x00, 0x77, 0x01, 0x00, 0xE8, 0x03, 0x00, 0x00,
		/* YResolution Data */           0x00, 0x77, 0x01, 0x00, 0xE8, 0x03, 0x00, 0x00
	};
	BYTE invalidBitsPerSampleR[] = {
		/* Header */                     0x49, 0x49, 0x2A, 0x00, 0x0E, 0x00, 0x00, 0x00, 0x80, 0x3F, 0xE0, 0x50, 0x10, 0x00,
		/* Number of Tags */             0x0F, 0x00,
		
		/* NewSubFileType */             0xFE, 0x00, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		/* ImageWidth */                 0x00, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* ImageHeight */                0x01, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* BitsPerSample */              0x02, 0x01, 0x03, 0x00, 0x03, 0x00, 0x00, 0x00, 0xC8, 0x00, 0x00, 0x00,
		/* Compression */                0x03, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
		/* PhotometricInterpretation */  0x06, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* StripOffsets */               0x11, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
		/* SamplesPerPixel */            0x15, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
		/* RowsPerStrip */               0x16, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* StripByteCounts */            0x17, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
		/* XResolution */                0x1A, 0x01, 0x05, 0x00, 0x01, 0x00, 0x00, 0x00, 0xCE, 0x00, 0x00, 0x00,
		/* YResolution */                0x1B, 0x01, 0x05, 0x00, 0x01, 0x00, 0x00, 0x00, 0xD6, 0x00, 0x00, 0x00,
		/* PlanarConfiguration */        0x1C, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* ResolutionUnit */             0x28, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* Predictor */                  0x3D, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* Next IFD Offset */            0x00, 0x00, 0x00, 0x00,
		
		/* BitsPerSample Data */         0x07, 0x00, 0x08, 0x00, 0x08, 0x00,
		/* XResolution Data */           0x00, 0x77, 0x01, 0x00, 0xE8, 0x03, 0x00, 0x00,
		/* YResolution Data */           0x00, 0x77, 0x01, 0x00, 0xE8, 0x03, 0x00, 0x00
	};
	BYTE invalidBitsPerSampleG[] = {
		/* Header */                     0x49, 0x49, 0x2A, 0x00, 0x0E, 0x00, 0x00, 0x00, 0x80, 0x3F, 0xE0, 0x50, 0x10, 0x00,
		/* Number of Tags */             0x0F, 0x00,
		
		/* NewSubFileType */             0xFE, 0x00, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		/* ImageWidth */                 0x00, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* ImageHeight */                0x01, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* BitsPerSample */              0x02, 0x01, 0x03, 0x00, 0x03, 0x00, 0x00, 0x00, 0xC8, 0x00, 0x00, 0x00,
		/* Compression */                0x03, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
		/* PhotometricInterpretation */  0x06, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* StripOffsets */               0x11, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
		/* SamplesPerPixel */            0x15, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
		/* RowsPerStrip */               0x16, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* StripByteCounts */            0x17, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
		/* XResolution */                0x1A, 0x01, 0x05, 0x00, 0x01, 0x00, 0x00, 0x00, 0xCE, 0x00, 0x00, 0x00,
		/* YResolution */                0x1B, 0x01, 0x05, 0x00, 0x01, 0x00, 0x00, 0x00, 0xD6, 0x00, 0x00, 0x00,
		/* PlanarConfiguration */        0x1C, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* ResolutionUnit */             0x28, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* Predictor */                  0x3D, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* Next IFD Offset */            0x00, 0x00, 0x00, 0x00,
		
		/* BitsPerSample Data */         0x08, 0x00, 0x07, 0x00, 0x08, 0x00,
		/* XResolution Data */           0x00, 0x77, 0x01, 0x00, 0xE8, 0x03, 0x00, 0x00,
		/* YResolution Data */           0x00, 0x77, 0x01, 0x00, 0xE8, 0x03, 0x00, 0x00
	};
	BYTE invalidBitsPerSampleB[] = {
		/* Header */                     0x49, 0x49, 0x2A, 0x00, 0x0E, 0x00, 0x00, 0x00, 0x80, 0x3F, 0xE0, 0x50, 0x10, 0x00,
		/* Number of Tags */             0x0F, 0x00,
		
		/* NewSubFileType */             0xFE, 0x00, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		/* ImageWidth */                 0x00, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* ImageHeight */                0x01, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* BitsPerSample */              0x02, 0x01, 0x03, 0x00, 0x03, 0x00, 0x00, 0x00, 0xC8, 0x00, 0x00, 0x00,
		/* Compression */                0x03, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
		/* PhotometricInterpretation */  0x06, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* StripOffsets */               0x11, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
		/* SamplesPerPixel */            0x15, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
		/* RowsPerStrip */               0x16, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* StripByteCounts */            0x17, 0x01, 0x04, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
		/* XResolution */                0x1A, 0x01, 0x05, 0x00, 0x01, 0x00, 0x00, 0x00, 0xCE, 0x00, 0x00, 0x00,
		/* YResolution */                0x1B, 0x01, 0x05, 0x00, 0x01, 0x00, 0x00, 0x00, 0xD6, 0x00, 0x00, 0x00,
		/* PlanarConfiguration */        0x1C, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
		/* ResolutionUnit */             0x28, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* Predictor */                  0x3D, 0x01, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
		/* Next IFD Offset */            0x00, 0x00, 0x00, 0x00,
		
		/* BitsPerSample Data */         0x08, 0x00, 0x08, 0x00, 0x07, 0x00,
		/* XResolution Data */           0x00, 0x77, 0x01, 0x00, 0xE8, 0x03, 0x00, 0x00,
		/* YResolution Data */           0x00, 0x77, 0x01, 0x00, 0xE8, 0x03, 0x00, 0x00
	};

	createFile (zeroImageWidth, sizeof (zeroImageWidth), OutOfMemory);
	createFile (zeroImageHeight, sizeof (zeroImageHeight), OutOfMemory);
	createFile (invalidBitsPerSampleR, sizeof (invalidBitsPerSampleR), OutOfMemory);
	createFile (invalidBitsPerSampleG, sizeof (invalidBitsPerSampleG), OutOfMemory);
	createFile (invalidBitsPerSampleB, sizeof (invalidBitsPerSampleB), OutOfMemory);
}

int
main (int argc, char**argv)
{
	GdiplusStartupInput gdiplusStartupInput;
	ULONG_PTR gdiplusToken;
	GdiplusStartup (&gdiplusToken, &gdiplusStartupInput, NULL);

	test_valid ();
	test_invalidHeader ();
	test_invalidFileDirectory ();
	test_invalidTag ();
	test_missingTag ();
	test_invalidSpecificTag ();

	deleteFile (file);

	GdiplusShutdown (gdiplusToken);
	return 0;
}
